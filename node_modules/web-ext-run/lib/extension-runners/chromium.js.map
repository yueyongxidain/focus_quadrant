{"version":3,"file":"chromium.js","names":["path","fs","asyncMkdirp","Launcher","ChromeLauncher","launch","defaultChromiumLaunch","WebSocket","WebSocketServer","set","createLogger","TempDir","isDirectory","fileExists","log","import","meta","url","EXCLUDED_CHROME_FLAGS","DEFAULT_CHROME_FLAGS","defaultFlags","filter","flag","includes","DEFAULT_PREFS","ChromiumExtensionRunner","cleanupCallbacks","params","chromiumInstance","chromiumLaunch","reloadManagerExtension","wss","exiting","_promiseSetupDone","constructor","Set","getName","run","setupInstance","isUserDataDir","dirPath","localStatePath","join","defaultPath","isProfileDir","securePreferencesPath","getProfilePaths","chromiumProfile","userDataDir","profileDirName","isProfileDirAndNotUserData","dir","base","parse","Promise","resolve","server","port","host","clientTracking","on","socket","err","debug","createReloadManagerExtension","extensions","concat","map","sourceDir","chromiumBinary","chromeFlags","push","args","keepProfileChanges","Error","tmpDir","create","tmpDirPath","copy","startingUrl","startUrl","startingUrls","Array","isArray","shift","enableExtensions","chromePath","ignoreDefaultFlags","prefs","getPrefs","process","once","info","exit","wssBroadcast","data","clients","cleanWebExtReloadComplete","client","removeEventListener","webExtReloadComplete","delete","message","msg","JSON","type","call","readyState","OPEN","addEventListener","send","stringify","size","registerCleanup","remove","extPath","Date","now","writeFile","manifest_version","name","version","permissions","background","scripts","wssInfo","address","bgPage","reloadAllExtensions","runnerName","stdout","write","toTimeString","reloadExtensionBySourceDir","extensionSourceDir","fn","add","catch","kill","wssClient","terminate","close","error","Object","entries","customChromiumPrefs","reduce","key","value"],"sources":["../../src/extension-runners/chromium.js"],"sourcesContent":["/**\n * This module provide an ExtensionRunner subclass that manage an extension executed\n * in a Chromium-based browser instance.\n */\n\nimport path from 'path';\n\nimport fs from 'fs-extra';\nimport asyncMkdirp from 'mkdirp';\nimport {\n  Launcher as ChromeLauncher,\n  launch as defaultChromiumLaunch,\n} from 'chrome-launcher';\nimport WebSocket, { WebSocketServer } from 'ws';\nimport set from 'set-value';\n\nimport { createLogger } from '../util/logger.js';\nimport { TempDir } from '../util/temp-dir.js';\nimport isDirectory from '../util/is-directory.js';\nimport fileExists from '../util/file-exists.js';\n\nconst log = createLogger(import.meta.url);\n\nconst EXCLUDED_CHROME_FLAGS = ['--disable-extensions', '--mute-audio'];\n\nexport const DEFAULT_CHROME_FLAGS = ChromeLauncher.defaultFlags().filter(\n  (flag) => !EXCLUDED_CHROME_FLAGS.includes(flag),\n);\n\nconst DEFAULT_PREFS = {\n  'extensions.ui.developer_mode': true,\n};\n\n/**\n * Implements an IExtensionRunner which manages a Chromium instance.\n */\nexport class ChromiumExtensionRunner {\n  cleanupCallbacks;\n  params;\n  chromiumInstance;\n  chromiumLaunch;\n  reloadManagerExtension;\n  wss;\n  exiting;\n  _promiseSetupDone;\n\n  constructor(params) {\n    const { chromiumLaunch = defaultChromiumLaunch } = params;\n    this.params = params;\n    this.chromiumLaunch = chromiumLaunch;\n    this.cleanupCallbacks = new Set();\n  }\n\n  // Method exported from the IExtensionRunner interface.\n\n  /**\n   * Returns the runner name.\n   */\n  getName() {\n    return 'Chromium';\n  }\n\n  async run() {\n    // Run should never be called more than once.\n    this._promiseSetupDone = this.setupInstance();\n    await this._promiseSetupDone;\n  }\n\n  static async isUserDataDir(dirPath) {\n    const localStatePath = path.join(dirPath, 'Local State');\n    const defaultPath = path.join(dirPath, 'Default');\n    // Local State and Default are typical for the user-data-dir\n    return (\n      (await fileExists(localStatePath)) && (await isDirectory(defaultPath))\n    );\n  }\n\n  static async isProfileDir(dirPath) {\n    const securePreferencesPath = path.join(dirPath, 'Secure Preferences');\n    //Secure Preferences is typical for a profile dir inside a user data dir\n    return await fileExists(securePreferencesPath);\n  }\n\n  static async getProfilePaths(chromiumProfile) {\n    if (!chromiumProfile) {\n      return {\n        userDataDir: null,\n        profileDirName: null,\n      };\n    }\n\n    const isProfileDirAndNotUserData =\n      (await ChromiumExtensionRunner.isProfileDir(chromiumProfile)) &&\n      !(await ChromiumExtensionRunner.isUserDataDir(chromiumProfile));\n\n    if (isProfileDirAndNotUserData) {\n      const { dir: userDataDir, base: profileDirName } =\n        path.parse(chromiumProfile);\n      return {\n        userDataDir,\n        profileDirName,\n      };\n    }\n\n    return {\n      userDataDir: chromiumProfile,\n      profileDirName: null,\n    };\n  }\n\n  /**\n   * Setup the Chromium Profile and run a Chromium instance.\n   */\n  async setupInstance() {\n    // Start a websocket server on a free localhost TCP port.\n    this.wss = await new Promise((resolve) => {\n      const server = new WebSocketServer(\n        // Use a ipv4 host so we don't need to escape ipv6 address\n        // https://github.com/mozilla/web-ext/issues/2331\n        { port: 0, host: '127.0.0.1', clientTracking: true },\n        // Wait the server to be listening (so that the extension\n        // runner can successfully retrieve server address and port).\n        () => resolve(server),\n      );\n    });\n\n    // Prevent unhandled socket error (e.g. when chrome\n    // is exiting, See https://github.com/websockets/ws/issues/1256).\n    this.wss.on('connection', function (socket) {\n      socket.on('error', (err) => {\n        log.debug(`websocket connection error: ${err}`);\n      });\n    });\n\n    // Create the extension that will manage the addon reloads\n    this.reloadManagerExtension = await this.createReloadManagerExtension();\n\n    // Start chrome pointing it to a given profile dir\n    const extensions = [this.reloadManagerExtension]\n      .concat(this.params.extensions.map(({ sourceDir }) => sourceDir))\n      .join(',');\n\n    const { chromiumBinary } = this.params;\n\n    log.debug('Starting Chromium instance...');\n\n    if (chromiumBinary) {\n      log.debug(`(chromiumBinary: ${chromiumBinary})`);\n    }\n\n    const chromeFlags = [...DEFAULT_CHROME_FLAGS];\n\n    chromeFlags.push(`--load-extension=${extensions}`);\n\n    if (this.params.args) {\n      chromeFlags.push(...this.params.args);\n    }\n\n    // eslint-disable-next-line prefer-const\n    let { userDataDir, profileDirName } =\n      await ChromiumExtensionRunner.getProfilePaths(\n        this.params.chromiumProfile,\n      );\n\n    if (userDataDir && this.params.keepProfileChanges) {\n      if (\n        profileDirName &&\n        !(await ChromiumExtensionRunner.isUserDataDir(userDataDir))\n      ) {\n        throw new Error(\n          'The profile you provided is not in a ' +\n            'user-data-dir. The changes cannot be kept. Please either ' +\n            'remove --keep-profile-changes or use a profile in a ' +\n            'user-data-dir directory',\n        );\n      }\n    } else if (!this.params.keepProfileChanges) {\n      // the user provided an existing profile directory but doesn't want\n      // the changes to be kept. we copy this directory to a temporary\n      // user data dir.\n      const tmpDir = new TempDir();\n      await tmpDir.create();\n      const tmpDirPath = tmpDir.path();\n\n      if (userDataDir && profileDirName) {\n        // copy profile dir to this temp user data dir.\n        await fs.copy(\n          path.join(userDataDir, profileDirName),\n          path.join(tmpDirPath, profileDirName),\n        );\n      } else if (userDataDir) {\n        await fs.copy(userDataDir, tmpDirPath);\n      }\n      userDataDir = tmpDirPath;\n    }\n\n    if (profileDirName) {\n      chromeFlags.push(`--profile-directory=${profileDirName}`);\n    }\n\n    let startingUrl;\n    if (this.params.startUrl) {\n      const startingUrls = Array.isArray(this.params.startUrl)\n        ? this.params.startUrl\n        : [this.params.startUrl];\n      startingUrl = startingUrls.shift();\n      chromeFlags.push(...startingUrls);\n    }\n\n    this.chromiumInstance = await this.chromiumLaunch({\n      enableExtensions: true,\n      chromePath: chromiumBinary,\n      chromeFlags,\n      startingUrl,\n      userDataDir,\n      // Ignore default flags to keep the extension enabled.\n      ignoreDefaultFlags: true,\n      prefs: this.getPrefs(),\n    });\n\n    this.chromiumInstance.process.once('close', () => {\n      this.chromiumInstance = null;\n\n      if (!this.exiting) {\n        log.info('Exiting on Chromium instance disconnected.');\n        this.exit();\n      }\n    });\n  }\n\n  async wssBroadcast(data) {\n    return new Promise((resolve) => {\n      const clients = this.wss ? new Set(this.wss.clients) : new Set();\n\n      function cleanWebExtReloadComplete() {\n        const client = this;\n        client.removeEventListener('message', webExtReloadComplete);\n        client.removeEventListener('close', cleanWebExtReloadComplete);\n        clients.delete(client);\n      }\n\n      const webExtReloadComplete = async (message) => {\n        const msg = JSON.parse(message.data);\n\n        if (msg.type === 'webExtReloadExtensionComplete') {\n          for (const client of clients) {\n            cleanWebExtReloadComplete.call(client);\n          }\n          resolve();\n        }\n      };\n\n      for (const client of clients) {\n        if (client.readyState === WebSocket.OPEN) {\n          client.addEventListener('message', webExtReloadComplete);\n          client.addEventListener('close', cleanWebExtReloadComplete);\n\n          client.send(JSON.stringify(data));\n        } else {\n          clients.delete(client);\n        }\n      }\n\n      if (clients.size === 0) {\n        resolve();\n      }\n    });\n  }\n\n  async createReloadManagerExtension() {\n    const tmpDir = new TempDir();\n    await tmpDir.create();\n    this.registerCleanup(() => tmpDir.remove());\n\n    const extPath = path.join(\n      tmpDir.path(),\n      `reload-manager-extension-${Date.now()}`,\n    );\n\n    log.debug(`Creating reload-manager-extension in ${extPath}`);\n\n    await asyncMkdirp(extPath);\n\n    await fs.writeFile(\n      path.join(extPath, 'manifest.json'),\n      JSON.stringify({\n        manifest_version: 2,\n        name: 'web-ext Reload Manager Extension',\n        version: '1.0',\n        permissions: ['management', 'tabs'],\n        background: {\n          scripts: ['bg.js'],\n        },\n      }),\n    );\n\n    const wssInfo = this.wss.address();\n\n    const bgPage = `(function bgPage() {\n      async function getAllDevExtensions() {\n        const allExtensions = await new Promise(\n          r => chrome.management.getAll(r));\n\n        return allExtensions.filter((extension) => {\n          return extension.enabled &&\n            extension.installType === \"development\" &&\n            extension.id !== chrome.runtime.id;\n        });\n      }\n\n      const setEnabled = (extensionId, value) =>\n        chrome.runtime.id == extensionId ?\n        new Promise.resolve() :\n        new Promise(r => chrome.management.setEnabled(extensionId, value, r));\n\n      async function reloadExtension(extensionId) {\n        await setEnabled(extensionId, false);\n        await setEnabled(extensionId, true);\n      }\n\n      const ws = new window.WebSocket(\n        \"ws://${wssInfo.address}:${wssInfo.port}\");\n\n      ws.onmessage = async (evt) => {\n        const msg = JSON.parse(evt.data);\n        if (msg.type === 'webExtReloadAllExtensions') {\n          const devExtensions = await getAllDevExtensions();\n          await Promise.all(devExtensions.map(ext => reloadExtension(ext.id)));\n          ws.send(JSON.stringify({ type: 'webExtReloadExtensionComplete' }));\n        }\n      };\n    })()`;\n\n    await fs.writeFile(path.join(extPath, 'bg.js'), bgPage);\n    return extPath;\n  }\n\n  /**\n   * Reloads all the extensions, collect any reload error and resolves to\n   * an array composed by a single ExtensionRunnerReloadResult object.\n   */\n  async reloadAllExtensions() {\n    const runnerName = this.getName();\n\n    await this.wssBroadcast({\n      type: 'webExtReloadAllExtensions',\n    });\n\n    process.stdout.write(\n      `\\rLast extension reload: ${new Date().toTimeString()}`,\n    );\n    log.debug('\\n');\n\n    return [{ runnerName }];\n  }\n\n  /**\n   * Reloads a single extension, collect any reload error and resolves to\n   * an array composed by a single ExtensionRunnerReloadResult object.\n   */\n  async reloadExtensionBySourceDir(\n    extensionSourceDir, // eslint-disable-line no-unused-vars\n  ) {\n    // TODO(rpl): detect the extension ids assigned to the\n    // target extensions and map it to the extensions source dir\n    // (https://github.com/mozilla/web-ext/issues/1687).\n    return this.reloadAllExtensions();\n  }\n\n  /**\n   * Register a callback to be called when the runner has been exited\n   * (e.g. the Chromium instance exits or the user has requested web-ext\n   * to exit).\n   */\n  registerCleanup(fn) {\n    this.cleanupCallbacks.add(fn);\n  }\n\n  /**\n   * Exits the runner, by closing the managed Chromium instance.\n   */\n  async exit() {\n    this.exiting = true;\n\n    // Wait for the setup to complete if the extension runner is already\n    // being started.\n    if (this._promiseSetupDone) {\n      // Ignore initialization errors if any.\n      await this._promiseSetupDone.catch((err) => {\n        log.debug(`ignored setup error on chromium runner shutdown: ${err}`);\n      });\n    }\n\n    if (this.chromiumInstance) {\n      await this.chromiumInstance.kill();\n      this.chromiumInstance = null;\n    }\n\n    if (this.wss) {\n      // Close all websocket clients, closing the WebSocketServer\n      // does not terminate the existing connection and it wouldn't\n      // resolve until all of the existing connections are closed.\n      for (const wssClient of this.wss?.clients || []) {\n        if (wssClient.readyState === WebSocket.OPEN) {\n          wssClient.terminate();\n        }\n      }\n      await new Promise((resolve) =>\n        this.wss ? this.wss.close(resolve) : resolve(),\n      );\n      this.wss = null;\n    }\n\n    // Call all the registered cleanup callbacks.\n    for (const fn of this.cleanupCallbacks) {\n      try {\n        fn();\n      } catch (error) {\n        log.error(error);\n      }\n    }\n  }\n\n  /**\n   * Returns a deep preferences object based on a set of flat preferences, like\n   * \"extensions.ui.developer_mode\".\n   */\n  getPrefs() {\n    return Object.entries({\n      ...DEFAULT_PREFS,\n      ...(this.params.customChromiumPrefs || {}),\n    }).reduce((prefs, [key, value]) => {\n      set(prefs, key, value);\n      return prefs;\n    }, {});\n  }\n}\n"],"mappings":"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"}