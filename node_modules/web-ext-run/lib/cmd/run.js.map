{"version":3,"file":"run.js","names":["fs","defaultBuildExtension","showDesktopNotification","defaultDesktopNotifications","defaultFirefoxApp","connectWithMaxRetries","defaultFirefoxClient","createLogger","defaultGetValidatedManifest","UsageError","createExtensionRunner","defaultReloadStrategy","MultiExtensionRunner","DefaultMultiExtensionRunner","log","import","meta","url","run","artifactsDir","browserConsole","devtools","pref","firefox","firefoxProfile","profileCreateIfMissing","keepProfileChanges","ignoreFiles","noInput","noReload","preInstall","sourceDir","watchFile","watchIgnored","startUrl","target","args","firefoxPreview","adbBin","adbHost","adbPort","adbDevice","adbDiscoveryTimeout","adbRemoveOldArtifacts","firefoxApk","firefoxApkComponent","chromiumBinary","chromiumPref","chromiumProfile","buildExtension","desktopNotifications","firefoxApp","firefoxClient","reloadStrategy","getValidatedManifest","info","Array","isArray","every","el","customPrefs","includes","customChromiumPrefs","manifestData","profileDir","isDir","existsSync","mkdir","runners","commonRunnerParams","extensions","length","firefoxDesktopRunnerParams","firefoxBinary","profilePath","firefoxDesktopRunner","params","push","firefoxAndroidRunnerParams","buildSourceDir","extensionSourceDir","tmpArtifactsDir","asNeeded","showReadyMessage","firefoxAndroidRunner","chromiumRunnerParams","chromiumRunner","extensionRunner"],"sources":["../../src/cmd/run.js"],"sourcesContent":["import { fs } from 'mz';\n\nimport defaultBuildExtension from './build.js';\nimport { showDesktopNotification as defaultDesktopNotifications } from '../util/desktop-notifier.js';\nimport * as defaultFirefoxApp from '../firefox/index.js';\nimport { connectWithMaxRetries as defaultFirefoxClient } from '../firefox/remote.js';\nimport { createLogger } from '../util/logger.js';\nimport defaultGetValidatedManifest from '../util/manifest.js';\nimport { UsageError } from '../errors.js';\nimport {\n  createExtensionRunner,\n  defaultReloadStrategy,\n  MultiExtensionRunner as DefaultMultiExtensionRunner,\n} from '../extension-runners/index.js';\n\nconst log = createLogger(import.meta.url);\n\n// Run command types and implementation.\n\nexport default async function run(\n  {\n    artifactsDir,\n    browserConsole = false,\n    devtools = false,\n    pref,\n    firefox,\n    firefoxProfile,\n    profileCreateIfMissing,\n    keepProfileChanges = false,\n    ignoreFiles,\n    noInput = false,\n    noReload = false,\n    preInstall = false,\n    sourceDir,\n    watchFile,\n    watchIgnored,\n    startUrl,\n    target,\n    args,\n    firefoxPreview = [],\n    // Android CLI options.\n    adbBin,\n    adbHost,\n    adbPort,\n    adbDevice,\n    adbDiscoveryTimeout,\n    adbRemoveOldArtifacts,\n    firefoxApk,\n    firefoxApkComponent,\n    // Chromium CLI options.\n    chromiumBinary,\n    chromiumPref,\n    chromiumProfile,\n  },\n  {\n    buildExtension = defaultBuildExtension,\n    desktopNotifications = defaultDesktopNotifications,\n    firefoxApp = defaultFirefoxApp,\n    firefoxClient = defaultFirefoxClient,\n    reloadStrategy = defaultReloadStrategy,\n    MultiExtensionRunner = DefaultMultiExtensionRunner,\n    getValidatedManifest = defaultGetValidatedManifest,\n  } = {},\n) {\n  log.info(`Running web extension from ${sourceDir}`);\n  if (preInstall) {\n    log.info(\n      \"Disabled auto-reloading because it's not possible with \" +\n        '--pre-install',\n    );\n    noReload = true;\n  }\n\n  if (\n    watchFile != null &&\n    (!Array.isArray(watchFile) ||\n      !watchFile.every((el) => typeof el === 'string'))\n  ) {\n    throw new UsageError('Unexpected watchFile type');\n  }\n\n  // Create an alias for --pref since it has been transformed into an\n  // object containing one or more preferences.\n  const customPrefs = { ...pref };\n  if (firefoxPreview.includes('mv3')) {\n    log.info('Configuring Firefox preferences for Manifest V3');\n    customPrefs['extensions.manifestV3.enabled'] = true;\n  }\n\n  // Create an alias for --chromium-pref since it has been transformed into an\n  // object containing one or more preferences.\n  const customChromiumPrefs = { ...chromiumPref };\n\n  const manifestData = await getValidatedManifest(sourceDir);\n\n  const profileDir = firefoxProfile || chromiumProfile;\n\n  if (profileCreateIfMissing) {\n    if (!profileDir) {\n      throw new UsageError(\n        '--profile-create-if-missing requires ' +\n          '--firefox-profile or --chromium-profile',\n      );\n    }\n    const isDir = fs.existsSync(profileDir);\n    if (isDir) {\n      log.info(`Profile directory ${profileDir} already exists`);\n    } else {\n      log.info(`Profile directory not found. Creating directory ${profileDir}`);\n      await fs.mkdir(profileDir);\n    }\n  }\n\n  const runners = [];\n\n  const commonRunnerParams = {\n    // Common options.\n    extensions: [{ sourceDir, manifestData }],\n    keepProfileChanges,\n    startUrl,\n    args,\n    desktopNotifications,\n  };\n\n  if (!target || target.length === 0 || target.includes('firefox-desktop')) {\n    const firefoxDesktopRunnerParams = {\n      ...commonRunnerParams,\n\n      // Firefox specific CLI options.\n      firefoxBinary: firefox,\n      profilePath: firefoxProfile,\n      customPrefs,\n      browserConsole,\n      devtools,\n      preInstall,\n\n      // Firefox runner injected dependencies.\n      firefoxApp,\n      firefoxClient,\n    };\n\n    const firefoxDesktopRunner = await createExtensionRunner({\n      target: 'firefox-desktop',\n      params: firefoxDesktopRunnerParams,\n    });\n    runners.push(firefoxDesktopRunner);\n  }\n\n  if (target && target.includes('firefox-android')) {\n    const firefoxAndroidRunnerParams = {\n      ...commonRunnerParams,\n\n      // Firefox specific CLI options.\n      profilePath: firefoxProfile,\n      customPrefs,\n      browserConsole,\n      preInstall,\n      firefoxApk,\n      firefoxApkComponent,\n      adbDevice,\n      adbHost,\n      adbPort,\n      adbBin,\n      adbDiscoveryTimeout,\n      adbRemoveOldArtifacts,\n\n      // Injected dependencies.\n      firefoxApp,\n      firefoxClient,\n      desktopNotifications: defaultDesktopNotifications,\n      buildSourceDir: (extensionSourceDir, tmpArtifactsDir) => {\n        return buildExtension(\n          {\n            sourceDir: extensionSourceDir,\n            ignoreFiles,\n            asNeeded: false,\n            // Use a separate temporary directory for building the extension zip file\n            // that we are going to upload on the android device.\n            artifactsDir: tmpArtifactsDir,\n          },\n          {\n            // Suppress the message usually logged by web-ext build.\n            showReadyMessage: false,\n          },\n        );\n      },\n    };\n\n    const firefoxAndroidRunner = await createExtensionRunner({\n      target: 'firefox-android',\n      params: firefoxAndroidRunnerParams,\n    });\n    runners.push(firefoxAndroidRunner);\n  }\n\n  if (target && target.includes('chromium')) {\n    const chromiumRunnerParams = {\n      ...commonRunnerParams,\n      chromiumBinary,\n      chromiumProfile,\n      customChromiumPrefs,\n    };\n\n    const chromiumRunner = await createExtensionRunner({\n      target: 'chromium',\n      params: chromiumRunnerParams,\n    });\n    runners.push(chromiumRunner);\n  }\n\n  const extensionRunner = new MultiExtensionRunner({\n    desktopNotifications,\n    runners,\n  });\n\n  await extensionRunner.run();\n\n  if (noReload) {\n    log.info('Automatic extension reloading has been disabled');\n  } else {\n    log.info('The extension will reload if any source file changes');\n\n    reloadStrategy({\n      extensionRunner,\n      sourceDir,\n      watchFile,\n      watchIgnored,\n      artifactsDir,\n      ignoreFiles,\n      noInput,\n    });\n  }\n\n  return extensionRunner;\n}\n"],"mappings":"AAAA,SAASA,EAAE,QAAQ,IAAI;AAEvB,OAAOC,qBAAqB,MAAM,YAAY;AAC9C,SAASC,uBAAuB,IAAIC,2BAA2B,QAAQ,6BAA6B;AACpG,OAAO,KAAKC,iBAAiB,MAAM,qBAAqB;AACxD,SAASC,qBAAqB,IAAIC,oBAAoB,QAAQ,sBAAsB;AACpF,SAASC,YAAY,QAAQ,mBAAmB;AAChD,OAAOC,2BAA2B,MAAM,qBAAqB;AAC7D,SAASC,UAAU,QAAQ,cAAc;AACzC,SACEC,qBAAqB,EACrBC,qBAAqB,EACrBC,oBAAoB,IAAIC,2BAA2B,QAC9C,+BAA+B;AAEtC,MAAMC,GAAG,GAAGP,YAAY,CAACQ,MAAM,CAACC,IAAI,CAACC,GAAG,CAAC;;AAEzC;;AAEA,eAAe,eAAeC,GAAGA,CAC/B;EACEC,YAAY;EACZC,cAAc,GAAG,KAAK;EACtBC,QAAQ,GAAG,KAAK;EAChBC,IAAI;EACJC,OAAO;EACPC,cAAc;EACdC,sBAAsB;EACtBC,kBAAkB,GAAG,KAAK;EAC1BC,WAAW;EACXC,OAAO,GAAG,KAAK;EACfC,QAAQ,GAAG,KAAK;EAChBC,UAAU,GAAG,KAAK;EAClBC,SAAS;EACTC,SAAS;EACTC,YAAY;EACZC,QAAQ;EACRC,MAAM;EACNC,IAAI;EACJC,cAAc,GAAG,EAAE;EACnB;EACAC,MAAM;EACNC,OAAO;EACPC,OAAO;EACPC,SAAS;EACTC,mBAAmB;EACnBC,qBAAqB;EACrBC,UAAU;EACVC,mBAAmB;EACnB;EACAC,cAAc;EACdC,YAAY;EACZC;AACF,CAAC,EACD;EACEC,cAAc,GAAGhD,qBAAqB;EACtCiD,oBAAoB,GAAG/C,2BAA2B;EAClDgD,UAAU,GAAG/C,iBAAiB;EAC9BgD,aAAa,GAAG9C,oBAAoB;EACpC+C,cAAc,GAAG1C,qBAAqB;EACtCC,oBAAoB,GAAGC,2BAA2B;EAClDyC,oBAAoB,GAAG9C;AACzB,CAAC,GAAG,CAAC,CAAC,EACN;EACAM,GAAG,CAACyC,IAAI,CAAE,8BAA6BxB,SAAU,EAAC,CAAC;EACnD,IAAID,UAAU,EAAE;IACdhB,GAAG,CAACyC,IAAI,CACN,yDAAyD,GACvD,eACJ,CAAC;IACD1B,QAAQ,GAAG,IAAI;EACjB;EAEA,IACEG,SAAS,IAAI,IAAI,KAChB,CAACwB,KAAK,CAACC,OAAO,CAACzB,SAAS,CAAC,IACxB,CAACA,SAAS,CAAC0B,KAAK,CAAEC,EAAE,IAAK,OAAOA,EAAE,KAAK,QAAQ,CAAC,CAAC,EACnD;IACA,MAAM,IAAIlD,UAAU,CAAC,2BAA2B,CAAC;EACnD;;EAEA;EACA;EACA,MAAMmD,WAAW,GAAG;IAAE,GAAGtC;EAAK,CAAC;EAC/B,IAAIe,cAAc,CAACwB,QAAQ,CAAC,KAAK,CAAC,EAAE;IAClC/C,GAAG,CAACyC,IAAI,CAAC,iDAAiD,CAAC;IAC3DK,WAAW,CAAC,+BAA+B,CAAC,GAAG,IAAI;EACrD;;EAEA;EACA;EACA,MAAME,mBAAmB,GAAG;IAAE,GAAGf;EAAa,CAAC;EAE/C,MAAMgB,YAAY,GAAG,MAAMT,oBAAoB,CAACvB,SAAS,CAAC;EAE1D,MAAMiC,UAAU,GAAGxC,cAAc,IAAIwB,eAAe;EAEpD,IAAIvB,sBAAsB,EAAE;IAC1B,IAAI,CAACuC,UAAU,EAAE;MACf,MAAM,IAAIvD,UAAU,CAClB,uCAAuC,GACrC,yCACJ,CAAC;IACH;IACA,MAAMwD,KAAK,GAAGjE,EAAE,CAACkE,UAAU,CAACF,UAAU,CAAC;IACvC,IAAIC,KAAK,EAAE;MACTnD,GAAG,CAACyC,IAAI,CAAE,qBAAoBS,UAAW,iBAAgB,CAAC;IAC5D,CAAC,MAAM;MACLlD,GAAG,CAACyC,IAAI,CAAE,mDAAkDS,UAAW,EAAC,CAAC;MACzE,MAAMhE,EAAE,CAACmE,KAAK,CAACH,UAAU,CAAC;IAC5B;EACF;EAEA,MAAMI,OAAO,GAAG,EAAE;EAElB,MAAMC,kBAAkB,GAAG;IACzB;IACAC,UAAU,EAAE,CAAC;MAAEvC,SAAS;MAAEgC;IAAa,CAAC,CAAC;IACzCrC,kBAAkB;IAClBQ,QAAQ;IACRE,IAAI;IACJc;EACF,CAAC;EAED,IAAI,CAACf,MAAM,IAAIA,MAAM,CAACoC,MAAM,KAAK,CAAC,IAAIpC,MAAM,CAAC0B,QAAQ,CAAC,iBAAiB,CAAC,EAAE;IACxE,MAAMW,0BAA0B,GAAG;MACjC,GAAGH,kBAAkB;MAErB;MACAI,aAAa,EAAElD,OAAO;MACtBmD,WAAW,EAAElD,cAAc;MAC3BoC,WAAW;MACXxC,cAAc;MACdC,QAAQ;MACRS,UAAU;MAEV;MACAqB,UAAU;MACVC;IACF,CAAC;IAED,MAAMuB,oBAAoB,GAAG,MAAMjE,qBAAqB,CAAC;MACvDyB,MAAM,EAAE,iBAAiB;MACzByC,MAAM,EAAEJ;IACV,CAAC,CAAC;IACFJ,OAAO,CAACS,IAAI,CAACF,oBAAoB,CAAC;EACpC;EAEA,IAAIxC,MAAM,IAAIA,MAAM,CAAC0B,QAAQ,CAAC,iBAAiB,CAAC,EAAE;IAChD,MAAMiB,0BAA0B,GAAG;MACjC,GAAGT,kBAAkB;MAErB;MACAK,WAAW,EAAElD,cAAc;MAC3BoC,WAAW;MACXxC,cAAc;MACdU,UAAU;MACVc,UAAU;MACVC,mBAAmB;MACnBJ,SAAS;MACTF,OAAO;MACPC,OAAO;MACPF,MAAM;MACNI,mBAAmB;MACnBC,qBAAqB;MAErB;MACAQ,UAAU;MACVC,aAAa;MACbF,oBAAoB,EAAE/C,2BAA2B;MACjD4E,cAAc,EAAEA,CAACC,kBAAkB,EAAEC,eAAe,KAAK;QACvD,OAAOhC,cAAc,CACnB;UACElB,SAAS,EAAEiD,kBAAkB;UAC7BrD,WAAW;UACXuD,QAAQ,EAAE,KAAK;UACf;UACA;UACA/D,YAAY,EAAE8D;QAChB,CAAC,EACD;UACE;UACAE,gBAAgB,EAAE;QACpB,CACF,CAAC;MACH;IACF,CAAC;IAED,MAAMC,oBAAoB,GAAG,MAAM1E,qBAAqB,CAAC;MACvDyB,MAAM,EAAE,iBAAiB;MACzByC,MAAM,EAAEE;IACV,CAAC,CAAC;IACFV,OAAO,CAACS,IAAI,CAACO,oBAAoB,CAAC;EACpC;EAEA,IAAIjD,MAAM,IAAIA,MAAM,CAAC0B,QAAQ,CAAC,UAAU,CAAC,EAAE;IACzC,MAAMwB,oBAAoB,GAAG;MAC3B,GAAGhB,kBAAkB;MACrBvB,cAAc;MACdE,eAAe;MACfc;IACF,CAAC;IAED,MAAMwB,cAAc,GAAG,MAAM5E,qBAAqB,CAAC;MACjDyB,MAAM,EAAE,UAAU;MAClByC,MAAM,EAAES;IACV,CAAC,CAAC;IACFjB,OAAO,CAACS,IAAI,CAACS,cAAc,CAAC;EAC9B;EAEA,MAAMC,eAAe,GAAG,IAAI3E,oBAAoB,CAAC;IAC/CsC,oBAAoB;IACpBkB;EACF,CAAC,CAAC;EAEF,MAAMmB,eAAe,CAACrE,GAAG,CAAC,CAAC;EAE3B,IAAIW,QAAQ,EAAE;IACZf,GAAG,CAACyC,IAAI,CAAC,iDAAiD,CAAC;EAC7D,CAAC,MAAM;IACLzC,GAAG,CAACyC,IAAI,CAAC,sDAAsD,CAAC;IAEhEF,cAAc,CAAC;MACbkC,eAAe;MACfxD,SAAS;MACTC,SAAS;MACTC,YAAY;MACZd,YAAY;MACZQ,WAAW;MACXC;IACF,CAAC,CAAC;EACJ;EAEA,OAAO2D,eAAe;AACxB"}